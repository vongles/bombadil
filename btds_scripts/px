#!/usr/bin/env python3
import os, sys, subprocess, shutil, re, socket
from pathlib import Path

def log(level, msg):
    colors = {"INFO": "\033[94m", "OK": "\033[92m", "WARN": "\033[93m", "ERR": "\033[91m"}
    print(f"{colors.get(level, '')}>> [{level}] {msg}\033[0m")

def get_btds_root():
    if "BTDS_ROOT" in os.environ: return Path(os.environ["BTDS_ROOT"])
    return Path.home() / "src" / "bombadil"

def is_remote_ready(host, root):
    vars_file = root / f"vars_{host}.toml"
    if not vars_file.exists(): return False
    with open(vars_file, 'r') as f:
        return 'px_ready = true' in f.read()

def process_chunk(chunk, root):
    chunk = chunk.replace('\r', '')
    lines = chunk.splitlines()
    meta = {parts[0].replace("# @pastex", "").strip(): parts[1].strip() 
            for line in lines[:20] if line.startswith("# @pastex") 
            for parts in [line.split(":", 1)] if len(parts) >= 2}
    
    if "file" not in meta: return
    
    this_host = socket.gethostname()
    target_host = meta.get("remote", "localhost")

    # DETERMINISTIC ROUTING
    if target_host in ["localhost", "loopback", "127.0.0.1", this_host]:
        repo_scripts = root / "btds_scripts"
        target_bin = Path.home() / ".local" / "bin" / "btds"
        repo_scripts.mkdir(parents=True, exist_ok=True)
        target_bin.mkdir(parents=True, exist_ok=True)
        
        script_path = repo_scripts / meta["file"]
        link_path = target_bin / meta["file"]
        
        with open(script_path, "w") as f:
            if "shebang" in meta:
                f.write(f"#!{meta['shebang']}\n")
                f.write("\n".join([l for l in lines if not l.strip().startswith("# @pastex")]) + "\n")
            else: f.write(chunk + "\n")
                
        script_path.chmod(0o755)
        if link_path.exists() or link_path.is_symlink(): link_path.unlink()
        link_path.symlink_to(script_path)
        log("OK", f"Local Deploy: {meta['file']}")
    else:
        if not is_remote_ready(target_host, root):
            log("ERR", f"Host '{target_host}' is NOT ready. (px_ready=true missing in vars_{target_host}.toml)")
            return
        log("INFO", f"Transmitting {meta['file']} to {target_host}...")
        process = subprocess.Popen(['ssh', target_host, f'~/.local/bin/btds/px_stdin && ~/.local/bin/btds/px /tmp/btds_clip'], 
                                   stdin=subprocess.PIPE, text=True)
        process.communicate(input=chunk)

def main():
    root = get_btds_root()
    content = ""
    if len(sys.argv) > 1 and os.path.exists(sys.argv[-1]):
        content = Path(sys.argv[-1]).read_text()
    else:
        cmd = next((t for t in ["termux-clipboard-get", "wl-paste", "xclip -o"] if shutil.which(t.split()[0])), None)
        if cmd: content = subprocess.check_output(cmd.split(), text=True)
    if not content: sys.exit(0)
    p_header = "# @pastex file:"
    chunks = [c.replace('\r', '').strip() for c in re.split(f'(?={p_header})', content) if p_header in c]
    for chunk in chunks: process_chunk(chunk, root)

if __name__ == "__main__": main()
