#!/bin/bash
# ==============================================================================
# B.T.D.S. VELOCITY TOOL: pastex v4.6.2 (Python-Written Stable Build)
# PURPOSE: Env-aware execution pipeline with Bombadil integration.
# ==============================================================================

pastex() {
    # --- 1. ENV DETECTION & FEEDBACK SETUP ---
    local RED='\033[0;31m'
    local GREEN='\033[0;32m'
    local BLUE='\033[0;34m'
    local YELLOW='\033[1;33m'
    local NC='\033[0m' # No Color

    log_info() { echo -e "${BLUE}>> [INFO] $1${NC}"; }
    log_success() { echo -e "${GREEN}>> [OK]   $1${NC}"; }
    log_warn() { echo -e "${YELLOW}>> [WARN] $1${NC}"; }
    log_err() { echo -e "${RED}>> [ERR]  $1${NC}"; }

    # Detect Package Manager (Polymorphism)
    local PKG_CMD=""
    if command -v pkg &> /dev/null; then
        PKG_CMD="pkg install -y" # Termux
    elif command -v yay &> /dev/null; then
        PKG_CMD="yay -S --noconfirm" # Arch (AUR)
    elif command -v pacman &> /dev/null; then
        PKG_CMD="sudo pacman -S --noconfirm" # Arch (Root)
    elif command -v apt &> /dev/null; then
        PKG_CMD="sudo apt install -y" # Debian/Ubuntu
    fi

    # --- 2. CONFIGURATION ---
    local CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/btds"
    local CONFIG_FILE="$CONFIG_DIR/pastex.toml"
    local TEMP_BUFFER="/tmp/pastex_buffer_$(date +%s)"

    mkdir -p "$CONFIG_DIR"

    # --- 3. CLIPBOARD INGESTION ---
    # We silently capture clipboard. If it fails, we error out.
    if command -v termux-clipboard-get &> /dev/null; then termux-clipboard-get > "$TEMP_BUFFER"
    elif command -v wl-paste &> /dev/null; then wl-paste > "$TEMP_BUFFER"
    elif command -v pbpaste &> /dev/null; then pbpaste > "$TEMP_BUFFER"
    elif command -v xclip &> /dev/null; then xclip -selection clipboard -o > "$TEMP_BUFFER"
    else
        log_err "No clipboard tool found (install xclip/wl-clipboard/termux-api)."
        rm "$TEMP_BUFFER"; return 1
    fi

    # --- 4. METADATA PARSING ---
    local head_content=$(head -n 20 "$TEMP_BUFFER")

    # Extract headers
    local raw_file=$(echo "$head_content" | grep -i "# @pastex file:" | cut -d':' -f2 | xargs)
    local meta_boot=$(echo "$head_content" | grep -i "# @pastex boot:" | cut -d':' -f2- | sed 's/^[ \t]*//')
    local meta_deps=$(echo "$head_content" | grep -i "# @pastex deps:" | cut -d':' -f2- | sed 's/^[ \t]*//')
    local meta_exec=$(echo "$head_content" | grep -i "# @pastex exec:" | cut -d':' -f2- | sed 's/^[ \t]*//')
    local meta_args=$(echo "$head_content" | grep -i "# @pastex args:" | cut -d':' -f2- | sed 's/^[ \t]*//')
    local meta_noexec=$(echo "$head_content" | grep -i "# @pastex noexec:" | cut -d':' -f2 | xargs)

    if [[ -z "$raw_file" ]] && [[ -z "$1" ]]; then
        log_err "No filename detected. Add '# @pastex file: <name>'."
        rm "$TEMP_BUFFER"; return 1
    fi

    # --- 5. PATH & BOMBADIL HANDOFF ---
    local target_file="${raw_file/#\~/$HOME}"
    local filename=$(basename "$target_file")
    if [[ "$1" != -* ]] && [[ -n "$1" ]]; then filename="$1"; shift; fi

    # Bombadil Config Lookup (With Fallbacks)
    local source_dir=""
    local deploy_dir=""
    
    if command -v yq &> /dev/null; then
        source_dir=$(yq '.paths.scripts_dir' "$CONFIG_FILE" -r 2>/dev/null)
        deploy_dir=$(yq '.paths.deploy_dir' "$CONFIG_FILE" -r 2>/dev/null)
    fi
    
    if [[ -z "$source_dir" || "$source_dir" == "null" ]]; then source_dir="$HOME/btds_dots/btds_scripts"; fi
    if [[ -z "$deploy_dir" || "$deploy_dir" == "null" ]]; then deploy_dir="$HOME/.local/bin/btds"; fi

    # Sanitize paths
    source_dir="${source_dir/#\$HOME/$HOME}"
    source_dir="${source_dir/#\~/$HOME}"
    deploy_dir="${deploy_dir/#\$HOME/$HOME}"
    deploy_dir="${deploy_dir/#\~/$HOME}"

    mkdir -p "$source_dir"
    mkdir -p "$deploy_dir"

    # Write & Link
    local source_path="$source_dir/$filename"
    local deploy_path="$deploy_dir/$filename"

    cat "$TEMP_BUFFER" > "$source_path"
    chmod +x "$source_path"
    ln -sf "$source_path" "$deploy_path"

    rm "$TEMP_BUFFER"
    log_success "Deployed: $filename"
    echo "         Source: $source_path"
    echo "         Link:   $deploy_path"

    # --- 6. ENVIRONMENT BOOTSTRAP ---

    # A. Install System Deps (Polymorphic)
    if [[ -n "$meta_deps" ]]; then
        if [[ -n "$PKG_CMD" ]]; then
            log_info "Installing System Dependencies: $meta_deps"
            $PKG_CMD $meta_deps
        else
            log_warn "Dependencies listed ($meta_deps) but no known package manager found."
        fi
    fi

    # B. Run Boot Command (Custom)
    if [[ -n "$meta_boot" ]]; then
        log_info "Running Boot Sequence..."
        local boot_cmd="${meta_boot//%f/$deploy_path}"
        eval "$boot_cmd"
    fi

    # --- 7. EXECUTION (DEFAULT: ON) ---

    # Check "No Exec" Switch
    if [[ "$meta_noexec" == "true" ]]; then
        log_warn "Auto-execution blocked by metadata (# @pastex noexec: true)"
        return 0
    fi

    # Check CLI "No Run" Flag
    local should_run=true
    for arg in "$@"; do if [[ "$arg" == "--no-run" ]]; then should_run=false; fi; done

    if [[ "$should_run" == true ]]; then
        log_info "Executing $filename..."
        echo "---------------------------------------------------"

        # Merge Args
        local exec_args=""
        if [[ -n "$meta_args" ]]; then exec_args="$meta_args"; fi

        if [[ -n "$meta_exec" ]]; then
            local cmd_str="${meta_exec//%f/$deploy_path}"
            eval "$cmd_str $exec_args"
        else
            "$deploy_path" $exec_args
        fi
    fi
}

# --- KERNEL WAKEUP CALL ---
# Allow sourcing (loading function) OR direct execution (running tool)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    pastex "$@"
fi

