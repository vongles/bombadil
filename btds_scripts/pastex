#!/bin/bash
# ==============================================================================
# B.T.D.S. VELOCITY TOOL: pastex v4.7 (Explicit Shebang)
# PURPOSE: Env-aware execution pipeline with clean binary generation.
# ==============================================================================

pastex() {
    # --- 1. ENV DETECTION ---
    local RED='\033[0;31m'
    local GREEN='\033[0;32m'
    local BLUE='\033[0;34m'
    local YELLOW='\033[1;33m'
    local NC='\033[0m'

    log_info() { echo -e "${BLUE}>> [INFO] $1${NC}"; }
    log_success() { echo -e "${GREEN}>> [OK]   $1${NC}"; }
    log_warn() { echo -e "${YELLOW}>> [WARN] $1${NC}"; }
    log_err() { echo -e "${RED}>> [ERR]  $1${NC}"; }

    local PKG_CMD=""
    if command -v yay &> /dev/null; then PKG_CMD="yay -S --noconfirm" 
    elif command -v pacman &> /dev/null; then
        if [ "$EUID" -ne 0 ]; then PKG_CMD="sudo pacman -S --noconfirm"
        else PKG_CMD="pacman -S --noconfirm"; fi
    elif command -v apt &> /dev/null; then PKG_CMD="sudo apt install -y" 
    elif command -v pkg &> /dev/null; then PKG_CMD="pkg install -y" 
    fi

    # --- 2. CONFIGURATION ---
    local CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/btds"
    local CONFIG_FILE="$CONFIG_DIR/pastex.toml"
    local TEMP_BUFFER="/tmp/pastex_buffer_$(date +%s)"
    mkdir -p "$CONFIG_DIR"

    # --- 3. INGESTION ---
    if command -v termux-clipboard-get &> /dev/null; then termux-clipboard-get > "$TEMP_BUFFER"
    elif command -v wl-paste &> /dev/null; then wl-paste > "$TEMP_BUFFER"
    elif command -v pbpaste &> /dev/null; then pbpaste > "$TEMP_BUFFER"
    elif command -v xclip &> /dev/null; then xclip -selection clipboard -o > "$TEMP_BUFFER"
    else log_err "No clipboard tool found."; rm "$TEMP_BUFFER"; return 1; fi

    # --- 4. METADATA PARSING ---
    # We scan the whole buffer for headers, but anchored to start of line to avoid false positives.
    
    local raw_file=$(grep "^[ \t]*# @pastex file:" "$TEMP_BUFFER" | head -n 1 | cut -d':' -f2 | xargs)
    local meta_shebang=$(grep "^[ \t]*# @pastex shebang:" "$TEMP_BUFFER" | head -n 1 | cut -d':' -f2- | xargs)
    local meta_boot=$(grep "^[ \t]*# @pastex boot:" "$TEMP_BUFFER" | head -n 1 | cut -d':' -f2- | sed 's/^[ \t]*//')
    local meta_deps=$(grep "^[ \t]*# @pastex deps:" "$TEMP_BUFFER" | head -n 1 | cut -d':' -f2- | sed 's/^[ \t]*//')
    local meta_exec=$(grep "^[ \t]*# @pastex exec:" "$TEMP_BUFFER" | head -n 1 | cut -d':' -f2- | sed 's/^[ \t]*//')
    local meta_args=$(grep "^[ \t]*# @pastex args:" "$TEMP_BUFFER" | head -n 1 | cut -d':' -f2- | sed 's/^[ \t]*//')
    local meta_noexec=$(grep "^[ \t]*# @pastex noexec:" "$TEMP_BUFFER" | head -n 1 | cut -d':' -f2 | xargs)

    if [[ -z "$raw_file" ]] && [[ -z "$1" ]]; then
        log_err "No filename detected. Add '# @pastex file: <name>'."
        rm "$TEMP_BUFFER"; return 1
    fi

    # --- 5. DEPLOYMENT ---
    local target_file="${raw_file/#\~/$HOME}"
    local filename=$(basename "$target_file")
    if [[ "$1" != -* ]] && [[ -n "$1" ]]; then filename="$1"; shift; fi

    local source_dir="$HOME/btds_dots/btds_scripts"
    local deploy_dir="$HOME/.local/bin/btds"
    
    # Simple YQ check
    if command -v yq &> /dev/null; then
        sd=$(yq '.paths.scripts_dir' "$CONFIG_FILE" -r 2>/dev/null)
        dd=$(yq '.paths.deploy_dir' "$CONFIG_FILE" -r 2>/dev/null)
        if [[ "$sd" != "null" && -n "$sd" ]]; then source_dir="$sd"; fi
        if [[ "$dd" != "null" && -n "$dd" ]]; then deploy_dir="$dd"; fi
    fi

    source_dir="${source_dir/#\$HOME/$HOME}"; source_dir="${source_dir/#\~/$HOME}"
    deploy_dir="${deploy_dir/#\$HOME/$HOME}"; deploy_dir="${deploy_dir/#\~/$HOME}"

    mkdir -p "$source_dir" "$deploy_dir"
    local source_path="$source_dir/$filename"
    local deploy_path="$deploy_dir/$filename"

    # --- WRITE LOGIC (SHEBANG SUPPORT) ---
    if [[ -n "$meta_shebang" ]]; then
        # 1. Write Shebang
        # 2. Append file content WITHOUT pastex metadata lines (Clean Binary)
        grep -v "^[ \t]*# @pastex" "$TEMP_BUFFER" >> "$source_path"
    else
        # Standard Dump
        cat "$TEMP_BUFFER" > "$source_path"
    fi

    chmod +x "$source_path"
    ln -sf "$source_path" "$deploy_path"
    rm "$TEMP_BUFFER"
    log_success "Deployed: $filename"

    # --- 6. BOOTSTRAP ---
    if [[ -n "$meta_deps" ]]; then
        if [[ -n "$PKG_CMD" ]]; then
            log_info "Installing Deps: $meta_deps"
            $PKG_CMD $meta_deps
        else log_warn "Deps listed ($meta_deps) but no pkg manager found."; fi
    fi

    if [[ -n "$meta_boot" ]]; then
        log_info "Running Boot..."
        local boot_cmd="${meta_boot//%f/$deploy_path}"
        eval "$boot_cmd"
    fi

    # --- 7. EXECUTION ---
    if [[ "$meta_noexec" == "true" ]]; then log_warn "Auto-exec blocked."; return 0; fi

    local should_run=true
    for arg in "$@"; do if [[ "$arg" == "--no-run" ]]; then should_run=false; fi; done

    if [[ "$should_run" == true ]]; then
        log_info "Executing $filename..."
        echo "---------------------------------------------------"
        local exec_args=""
        if [[ -n "$meta_args" ]]; then exec_args="$meta_args"; fi

        if [[ -n "$meta_exec" ]]; then
            local cmd_str="${meta_exec//%f/$deploy_path}"
            eval "$cmd_str $exec_args"
        else "$deploy_path" $exec_args; fi
    fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then pastex "$@"; fi
