#!/usr/bin/env python3
import os
import sys
import subprocess
import shutil
from pathlib import Path

def log(level, msg):
    colors = {"INFO": "\033[94m", "OK": "\033[92m", "WARN": "\033[93m", "ERR": "\033[91m"}
    print(f"{colors.get(level, '')}>> [{level}] {msg}\033[0m")

def main():
    # 1. GET CLIPBOARD
    try:
        if shutil.which("termux-clipboard-get"):
            content = subprocess.check_output("termux-clipboard-get", text=True)
        elif shutil.which("wl-paste"):
            content = subprocess.check_output("wl-paste", text=True)
        elif shutil.which("xclip"):
            content = subprocess.check_output(["xclip", "-o"], text=True)
        else:
            log("ERR", "No clipboard tool found.")
            sys.exit(1)
    except Exception as e:
        log("ERR", f"Clipboard error: {e}")
        sys.exit(1)

    lines = content.splitlines()
    meta = {}
    
    # 2. PARSE METADATA
    for line in lines[:20]:
        line = line.strip()
        if not line.startswith("# @pastex"): continue
        
        parts = line.split(":", 1)
        if len(parts) < 2: continue
        
        key = parts[0].replace("# @pastex", "").strip()
        val = parts[1].strip()
        meta[key] = val

    if "file" not in meta:
        log("ERR", "No '# @pastex file: <name>' header found.")
        sys.exit(1)

    # 3. PATHS
    # Hardcoded to your Bombadil structure
    home = Path.home()
    repo_scripts = home / "btds_dots" / "btds_scripts"
    target_bin = home / ".local" / "bin" / "btds"
    
    repo_scripts.mkdir(parents=True, exist_ok=True)
    target_bin.mkdir(parents=True, exist_ok=True)

    filename = meta["file"]
    script_path = repo_scripts / filename
    link_path = target_bin / filename

    # 4. WRITE FILE
    with open(script_path, "w") as f:
        # Handle Shebang
        if "shebang" in meta:
            f.write(f"#!{meta['shebang']}\n")
            # Write content excluding metadata lines
            for line in lines:
                if not line.strip().startswith("# @pastex"):
                    f.write(line + "\n")
        else:
            # Dump all
            f.write(content)

    script_path.chmod(0o755)
    
    # 5. LINK
    if link_path.exists() or link_path.is_symlink():
        link_path.unlink()
    link_path.symlink_to(script_path)
    
    log("OK", f"Deployed: {filename}")

    # 6. BOOT & EXEC
    if "deps" in meta:
        log("INFO", f"Checking deps: {meta['deps']}")
        # (Simplified dep check logic here if needed)

    if "boot" in meta:
        log("INFO", "Running boot...")
        boot_cmd = meta["boot"].replace("%f", str(link_path))
        os.system(boot_cmd)

    if meta.get("noexec") != "true":
        log("INFO", f"Executing {filename}...")
        log("INFO", "--------------------------------")
        args = meta.get("args", "")
        cmd = meta.get("exec", str(link_path)).replace("%f", str(link_path))
        os.system(f"{cmd} {args}")

if __name__ == "__main__":
    main()
