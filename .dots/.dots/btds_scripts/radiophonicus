#!/usr/bin/env python3

import sys, argparse, re, os, subprocess, shutil
try:
    import tomllib
except ImportError:
    import tomli as tomllib
from pathlib import Path
from urllib.parse import unquote

__version__ = "2.4.2"

def natural_key(string_):
    return [int(s) if s.isdigit() else s.lower() for s in re.split(r'(\d+)', str(string_))]

def parse_input(content):
    tracks = []
    for idx, line in enumerate(content.splitlines()):
        line = line.strip()
        if not line or line.startswith("#"): continue
        parts = line.split("|")
        if len(parts) >= 4:
            tracks.append({
                "ingest_idx": idx, "title": parts[0], "artist": parts[1],
                "album": parts[2], "mrl": parts[3],
                "track": parts[4] if len(parts) > 4 else "0",
                "date": parts[5] if len(parts) > 5 else "0000-00-00",
                "category": parts[6] if len(parts) > 6 else "General",
                "section": parts[7] if len(parts) > 7 else "Default"
            })
    return tracks

def generate_m3u(tracks, output_file, sort_fields=None):
    abs_path = Path(output_file).expanduser().resolve()
    if sort_fields:
        fields = [f.strip().lower() for f in sort_fields.split(",")]
        def sort_logic(x):
            sort_tuple = []
            for f in fields:
                val = x.get(f, "")
                sort_tuple.append(natural_key(val) if f == 'track' else str(val).lower())
            sort_tuple.append(x['ingest_idx'])
            return tuple(sort_tuple)
        tracks.sort(key=sort_logic)
    try:
        abs_path.parent.mkdir(parents=True, exist_ok=True)
        with open(abs_path, 'w', encoding='utf-8') as f:
            f.write("#EXTM3U\n")
            for t in tracks:
                f.write(f"#EXTINF:-1, {t['artist']} - {t['title']}\n")
                f.write(f"#EXTGRP:{t['section']}\n")
                path = unquote(t['mrl']).replace("file://", "")
                f.write(f"{path}\n")
        return True
    except Exception as e:
        print(f">> [ERR] Write failed: {e}")
        return False

def main():
    conf_path = Path("~/.config/btds/radiophonicus.toml").expanduser()
    if not conf_path.exists():
        print(f">> [ERR_CONFIG_MISSING] Target: {conf_path}")
        print(f">> [ACTION] 1. Ensure 'radiophonicus.toml' is in 'bombadil/.dots/'")
        print(f">> [ACTION] 2. Run: bombadil link")
        sys.exit(1)

    with open(conf_path, "rb") as f:
        config = tomllib.load(f)

    parser = argparse.ArgumentParser()
    parser.add_argument("--version", action="version", version=f"radiophonicus {__version__}")
    parser.add_argument("--px", action="store_true")
    parser.add_argument("--sort", default=config.get("sorting", {}).get("default_sort", "album,track,date"))
    parser.add_argument("--output", default=config.get("paths", {}).get("default_output", "playlist.m3u8"))
    args = parser.parse_args()

    content = sys.stdin.read()
    tracks = parse_input(content)
    if generate_m3u(tracks, args.output, args.sort):
        print(f">> [OK] Generated {args.output}")

if __name__ == "__main__":
    main()
