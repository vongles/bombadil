#!/usr/bin/env python3
# @pastex file: btds_ingest
# @pastex deps: python-rich
# @pastex exec: python3 %f
# @pastex args: --help
# @pastex usage: Parses Pipe-Delimited Manifests (V1.4)

import re
import json
import sys
import argparse
from pathlib import Path
from rich.console import Console
from rich.panel import Panel

console = Console()

def parse_manifest(text):
    data = {"system_name": "B.T.D.S. OMNISYSTEM KERNEL", "sections": {}}
    sections = re.split(r'\n(?=[A-F]\. )', text)
    
    for section in sections:
        section = section.strip()
        if not section: continue
        
        # Extract Title
        title_match = re.match(r'([A-F]\. .*?)(?:\n|$)', section)
        if title_match:
            title = title_match.group(1).strip()
            content = section[len(title):].strip()
            key = title.split(' ', 1)[0].replace('.', '')
            section_name = title.split(' ', 1)[1] if ' ' in title else title
            
            entry = {"title": section_name, "content": content}
            
            # Specific parsing logic
            if "SEPTUMVIRATE" in section_name.upper():
                entry["agents"] = parse_table(content, ["agent", "version", "function", "phrase"])
            elif "LEGIO" in section_name.upper():
                entry["legions"] = parse_table(content, ["id", "name", "centurion", "specialists", "core_function"])
            
            data["sections"][key] = entry
    return data

def parse_table(content, headers):
    """Generic parser for Pipe (|) delimited tables"""
    rows = []
    lines = content.split('\n')
    
    for line in lines:
        if "|" not in line: continue # Skip non-table lines
        if "---" in line: continue   # Skip separator lines
        if "Legio ID" in line or "Agent" in line: continue # Skip headers
        
        # Split by pipe and strip whitespace
        parts = [p.strip() for p in line.split('|')]
        
        # Handle cases where leading/trailing pipes create empty strings
        if parts[0] == '': parts.pop(0)
        if parts and parts[-1] == '': parts.pop()
        
        if len(parts) >= len(headers):
            entry = {}
            for i, header in enumerate(headers):
                entry[header] = parts[i] if i < len(parts) else ""
            rows.append(entry)
            
    return rows

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("file", nargs='?')
    parser.add_argument("--out")
    args = parser.parse_args()

    console.print(Panel("[bold cyan]B.T.D.S. IDEA ENGINE[/bold cyan] [dim]v1.4 (Pipe-Delimited)[/dim]", border_style="cyan"))

    if not args.file: return
    
    filepath = Path(args.file)
    if not filepath.exists(): sys.exit(1)

    try:
        with open(filepath, 'r', encoding='utf-8') as f: raw_text = f.read()
        console.print(f"[green]âœ” Ingesting:[/green] {filepath}")
        
        data = parse_manifest(raw_text)
        out_path = Path(args.out) if args.out else filepath.with_suffix('.json')

        with open(out_path, 'w', encoding='utf-8') as f:
            json.dump(data, f, indent=4)
        console.print(f"[bold white]Exported to:[/bold white] {out_path}")
        
    except Exception as e:
        console.print(f"[bold red]PANIC:[/bold red] {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
